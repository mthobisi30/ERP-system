{% extends "layout.html" %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <a href="/{{ view_name }}" class="text-primary-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to {{ title }}</a>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-100 bg-gradient-to-r from-primary-600 to-primary-500">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-plus-circle mr-2"></i>Create New {{ title }}</h2>
        </div>
        <form id="create-form" class="p-6 space-y-6">
            <div id="form-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Fields will be dynamically generated by JavaScript -->
                <div class="col-span-2 text-center text-gray-400 py-8">
                    <i class="fas fa-circle-notch fa-spin text-2xl"></i>
                    <p class="mt-2">Loading form...</p>
                </div>
            </div>
            <div class="flex justify-end gap-4 pt-4 border-t border-gray-100">
                <a href="/{{ view_name }}" class="px-6 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</a>
                <button type="submit" class="px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-semibold shadow-sm transition-colors">
                    <i class="fas fa-save mr-2"></i>Save {{ title }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const VIEW_SCHEMAS = {
    'projects': { title: 'Project', fields: [ {id: 'name', label: 'Project Name', required: true}, {id: 'description', label: 'Description', type: 'textarea'}, {id: 'status', label: 'Status', type: 'select', options: ['active', 'paused', 'completed']} ] },
    'tasks': { title: 'Task', fields: [ {id: 'title', label: 'Task Title', required: true}, {id: 'description', label: 'Description', type: 'textarea'}, {id: 'status', label: 'Status', type: 'select', options: ['todo', 'in_progress', 'done']}, {id: 'due_date', label: 'Due Date', type: 'date'} ] },
    'customers': { title: 'Customer', fields: [ {id: 'name', label: 'Company Name', required: true}, {id: 'email', label: 'Email', type: 'email'}, {id: 'phone', label: 'Phone'}, {id: 'address', label: 'Address', type: 'textarea'} ] },
    'leads': { title: 'Lead', fields: [ {id: 'name', label: 'Lead Name', required: true}, {id: 'email', label: 'Email', type: 'email'}, {id: 'phone', label: 'Phone'}, {id: 'source', label: 'Source'}, {id: 'status', label: 'Status', type: 'select', options: ['new', 'contacted', 'qualified', 'lost']} ] },
    'opportunities': { title: 'Opportunity', fields: [ {id: 'name', label: 'Opportunity Name', required: true}, {id: 'amount', label: 'Estimated Value', type: 'number'}, {id: 'stage', label: 'Stage', type: 'select', options: ['discovery', 'proposal', 'negotiation', 'closed_won', 'closed_lost']} ] },
    'products': { title: 'Product', fields: [ {id: 'name', label: 'Product Name', required: true}, {id: 'sku', label: 'SKU', required: true}, {id: 'description', label: 'Description', type: 'textarea'}, {id: 'unit_price', label: 'Unit Price', type: 'number', required: true} ] },
    'inventory': { title: 'Inventory Item', fields: [ {id: 'product_id', label: 'Product ID (UUID)'}, {id: 'warehouse_id', label: 'Warehouse ID (UUID)'}, {id: 'quantity_on_hand', label: 'Quantity', type: 'number', required: true} ] },
    'warehouses': { title: 'Warehouse', fields: [ {id: 'name', label: 'Warehouse Name', required: true}, {id: 'code', label: 'Code', required: true}, {id: 'location', label: 'Location'} ] },
    'suppliers': { title: 'Supplier', fields: [ {id: 'name', label: 'Supplier Name', required: true}, {id: 'contact_person', label: 'Contact Person'}, {id: 'email', label: 'Email', type: 'email'}, {id: 'phone', label: 'Phone'} ] },
    'hr': { title: 'Employee', fields: [ {id: 'first_name', label: 'First Name', required: true}, {id: 'last_name', label: 'Last Name', required: true}, {id: 'email', label: 'Email', type: 'email'}, {id: 'position', label: 'Position'}, {id: 'department', label: 'Department'} ] },
    'invoices': { title: 'Invoice', fields: [ {id: 'invoice_number', label: 'Invoice Number', required: true}, {id: 'customer_id', label: 'Customer ID (UUID)'}, {id: 'total_amount', label: 'Total Amount', type: 'number'}, {id: 'due_date', label: 'Due Date', type: 'date'} ] },
    'expenses': { title: 'Expense', fields: [ {id: 'description', label: 'Description', required: true}, {id: 'amount', label: 'Amount', type: 'number', required: true}, {id: 'category', label: 'Category', type: 'select', options: ['travel', 'office', 'utilities', 'marketing', 'other']}, {id: 'date', label: 'Date', type: 'date'} ] },
    'tickets': { title: 'Support Ticket', fields: [ {id: 'subject', label: 'Subject', required: true}, {id: 'description', label: 'Description', type: 'textarea'}, {id: 'priority', label: 'Priority', type: 'select', options: ['low', 'medium', 'high', 'urgent']} ] },
    'schedule': { title: 'Event', fields: [ {id: 'title', label: 'Event Title', required: true}, {id: 'description', label: 'Description', type: 'textarea'}, {id: 'start_time', label: 'Start Time', type: 'datetime-local', required: true}, {id: 'end_time', label: 'End Time', type: 'datetime-local'} ] },
    'documents': { title: 'Document', fields: [ {id: 'name', label: 'Document Name', required: true}, {id: 'category', label: 'Category'}, {id: 'file', label: 'File', type: 'file'} ] },
};

const VIEW_NAME = '{{ view_name }}';
const API_BASE = '/api';

document.addEventListener('DOMContentLoaded', function() {
    const schema = VIEW_SCHEMAS[VIEW_NAME] || { title: VIEW_NAME, fields: [{id: 'name', label: 'Name', required: true}] };
    renderFormFields(schema.fields);
});

function renderFormFields(fields) {
    const container = document.getElementById('form-fields');
    container.innerHTML = fields.map(f => {
        const colSpan = f.type === 'textarea' ? 'col-span-2' : '';
        const requiredAttr = f.required ? 'required' : '';
        const requiredStar = f.required ? '<span class="text-red-500 ml-1">*</span>' : '';
        
        if (f.type === 'select') {
            return `
                <div class="${colSpan}">
                    <label class="block text-sm font-medium text-gray-700 mb-2">${f.label}${requiredStar}</label>
                    <select name="${f.id}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 bg-gray-50" ${requiredAttr}>
                        <option value="">Select ${f.label}...</option>
                        ${f.options.map(o => `<option value="${o}">${o.replace(/_/g, ' ')}</option>`).join('')}
                    </select>
                </div>`;
        } else if (f.type === 'textarea') {
            return `
                <div class="${colSpan}">
                    <label class="block text-sm font-medium text-gray-700 mb-2">${f.label}${requiredStar}</label>
                    <textarea name="${f.id}" rows="3" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 bg-gray-50" ${requiredAttr}></textarea>
                </div>`;
        } else {
            return `
                <div class="${colSpan}">
                    <label class="block text-sm font-medium text-gray-700 mb-2">${f.label}${requiredStar}</label>
                    <input type="${f.type || 'text'}" name="${f.id}" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 bg-gray-50" ${requiredAttr}>
                </div>`;
        }
    }).join('');
}

document.getElementById('create-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const body = Object.fromEntries(formData.entries());
    
    const token = localStorage.getItem('erp_token');
    if (!token) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    // Map view name to API endpoint
    const ENDPOINT_MAP = {
        'projects': '/projects', 'tasks': '/tasks', 'customers': '/customers', 'leads': '/leads',
        'opportunities': '/opportunities', 'products': '/products', 'inventory': '/inventory',
        'warehouses': '/inventory/warehouses', 'suppliers': '/suppliers', 'hr': '/hr',
        'invoices': '/invoices', 'expenses': '/expenses', 'tickets': '/tickets',
        'schedule': '/schedule', 'documents': '/documents', 'sales': '/sales/orders',
        'quotations': '/sales/quotations', 'procurement': '/procurement/purchase-orders',
        'accounting': '/accounting/accounts', 'journal_entries': '/accounting/journal-entries',
        'attendance': '/hr/attendance', 'leaves': '/hr/leaves', 'performance': '/hr/performance-reviews',
        'users': '/users', 'time-tracking': '/time-tracking', 'notifications': '/notifications',
        'reports': '/reports', 'payments': '/payments'
    };
    
    const endpoint = ENDPOINT_MAP[VIEW_NAME] || `/${VIEW_NAME}`;
    
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(body)
        });
        
        if (response.ok) {
            // Show success and redirect back to list
            window.location.href = '/' + VIEW_NAME + '?created=1';
        } else {
            const err = await response.json();
            alert('Error: ' + (err.error || err.message || 'Failed to create'));
        }
    } catch (err) {
        console.error(err);
        alert('Connection error. Please try again.');
    }
});
</script>
{% endblock %}
